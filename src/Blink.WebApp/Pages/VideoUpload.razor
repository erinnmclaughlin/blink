@page "/video-upload"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.JSInterop
@using System.Text.Json
@inject BlinkApiClient ApiClient
@inject ILogger<VideoUpload> Logger
@inject IJSRuntime JS
@inject IAccessTokenProvider TokenProvider
@inject IConfiguration Configuration
@attribute [Authorize]

<PageTitle>Video Upload</PageTitle>

<h1>Video Upload</h1>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Upload Your Video</h5>
                </div>
                <div class="card-body">
                    @if (isUploading)
                    {
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Uploading...</span>
                                </div>
                                <span>Uploading video... Please wait.</span>
                            </div>
                            @if (uploadProgress > 0)
                            {
                                <div class="progress mt-3">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: @(uploadProgress)%"
                                         aria-valuenow="@uploadProgress" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        @uploadProgress%
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Error!</strong> @errorMessage
                            <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <strong>Success!</strong> @successMessage
                            <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                        </div>
                    }

                    <div class="mb-3">
                        <label for="videoFile" class="form-label">Select Video File</label>
                        <InputFile @ref="fileInputRef"
                                   OnChange="OnFileSelected" 
                                   class="form-control" 
                                   id="videoFile" 
                                   accept="video/*"
                                   disabled="@isUploading" />
                        <div class="form-text">
                            Supported formats: MP4, AVI, MOV, WMV, FLV, WEBM, MKV (Max size: 2GB)
                        </div>
                    </div>

                    @if (selectedFile != null)
                    {
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Selected File:</h6>
                                <p class="card-text mb-1">
                                    <strong>Name:</strong> @selectedFile.Name
                                </p>
                                <p class="card-text mb-1">
                                    <strong>Size:</strong> @FormatFileSize(selectedFile.Size)
                                </p>
                                <p class="card-text mb-0">
                                    <strong>Type:</strong> @selectedFile.ContentType
                                </p>
                            </div>
                        </div>
                    }

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" 
                                @onclick="UploadVideo" 
                                disabled="@(selectedFile == null || isUploading)">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Uploading...</span>
                            }
                            else
                            {
                                <span>Upload Video</span>
                            }
                        </button>
                    </div>
                </div>
            </div>

            @if (uploadedVideos.Count > 0)
            {
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Upload History</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            @foreach (var video in uploadedVideos.OrderByDescending(v => v.UploadedAt))
                            {
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@video.FileName</h6>
                                        <small class="text-muted">@video.UploadedAt.ToString("g")</small>
                                    </div>
                                    <p class="mb-1"><small><strong>Blob Name:</strong> @video.BlobName</small></p>
                                    <small class="text-muted">Size: @FormatFileSize(video.FileSize)</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Instructions</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li class="mb-2">Click "Choose File" to select a video from your device</li>
                        <li class="mb-2">Review the file details to ensure it's the correct video</li>
                        <li class="mb-2">Click "Upload Video" to start the upload process</li>
                        <li class="mb-2">Wait for the upload to complete</li>
                    </ol>
                    
                    <hr />
                    
                    <h6>Tips:</h6>
                    <ul class="small">
                        <li>Ensure your video file is under 2GB</li>
                        <li>Supported formats include MP4, AVI, MOV, and more</li>
                        <li>Do not close or refresh the page during upload</li>
                        <li>Upload times vary based on file size and connection speed</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private InputFile? fileInputRef;
    private IBrowserFile? selectedFile;
    private bool isUploading;
    private int uploadProgress;
    private string? errorMessage;
    private string? successMessage;
    private List<UploadedVideoInfo> uploadedVideos = new();

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        ClearMessages();
    }

    private async Task UploadVideo()
    {
        if (selectedFile == null || fileInputRef == null)
            return;

        isUploading = true;
        uploadProgress = 0;
        ClearMessages();

        try
        {
            // Validate file size (2GB)
            const long maxFileSize = 2000L * 1024 * 1024;
            if (selectedFile.Size > maxFileSize)
            {
                errorMessage = "File size exceeds the maximum allowed size of 2GB.";
                return;
            }

            // Get access token for authentication
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (!tokenResult.TryGetToken(out var token))
            {
                errorMessage = "Failed to get authentication token.";
                return;
            }

            // Simulate progress (since we can't track actual upload progress easily)
            var progressTask = SimulateProgress();

            // Get the API base address
            var apiBaseAddress = Configuration["BlinkApi:BaseAddress"]?.TrimEnd('/');
            if (string.IsNullOrEmpty(apiBaseAddress))
            {
                errorMessage = "API base address not configured";
                return;
            }
            var uploadUrl = $"{apiBaseAddress}/api/videos/upload";

            // Use JavaScript Fetch API for large file upload (avoids memory buffering)
            var fileInputElement = fileInputRef.Element;
            var response = await JS.InvokeAsync<JsonElement>("uploadLargeFile", 
                uploadUrl, 
                fileInputElement, 
                token.Value);

            uploadProgress = 100;
            await Task.Delay(500); // Brief delay to show 100%

            var blobName = response.GetProperty("blobName").GetString() ?? "";
            var fileName = response.GetProperty("fileName").GetString() ?? selectedFile.Name;
            var fileSize = response.GetProperty("fileSize").GetInt64();

            successMessage = $"Video uploaded successfully! Blob: {blobName}";
            
            uploadedVideos.Add(new UploadedVideoInfo
            {
                FileName = fileName,
                BlobName = blobName,
                FileSize = fileSize,
                UploadedAt = DateTime.Now
            });

            selectedFile = null;
            
            Logger.LogInformation("Video uploaded successfully: {FileName}", fileName);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to upload video: {ex.Message}";
            Logger.LogError(ex, "Error uploading video");
        }
        finally
        {
            isUploading = false;
            uploadProgress = 0;
        }
    }

    private async Task SimulateProgress()
    {
        // Simulate upload progress
        for (int i = 0; i <= 90; i += 10)
        {
            if (!isUploading) break;
            uploadProgress = i;
            StateHasChanged();
            await Task.Delay(500);
        }
    }

    private void ClearMessages()
    {
        errorMessage = null;
        successMessage = null;
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private class UploadedVideoInfo
    {
        public string FileName { get; set; } = string.Empty;
        public string BlobName { get; set; } = string.Empty;
        public long FileSize { get; set; }
        public DateTime UploadedAt { get; set; }
    }
}


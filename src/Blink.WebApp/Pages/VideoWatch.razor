@page "/videos/watch/{BlobName}"
@inject BlinkApiClient ApiClient
@inject ILogger<VideoWatch> Logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>@(video != null ? GetDisplayTitle(video) : "Watch Video")</PageTitle>

<div class="container mt-4">
    @if (isLoadingVideo)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading video...</span>
            </div>
            <p class="mt-3">Loading video...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <strong>Error!</strong> @errorMessage
        </div>
        <div class="text-center">
            <button class="btn btn-primary" @onclick="GoBackToList">
                <span class="bi bi-arrow-left"></span> Back to Videos
            </button>
        </div>
    }
    else if (video != null)
    {
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="mb-3">
                    <button class="btn btn-outline-secondary" @onclick="GoBackToList">
                        <span class="bi bi-arrow-left"></span> Back to Videos
                    </button>
                </div>
                
                <div class="card shadow-sm">
                    <div class="card-header">
                        @if (isEditing)
                        {
                            <div class="mb-3">
                                <label for="editTitle" class="form-label fw-bold">Title</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="editTitle" 
                                       @bind="editTitle"
                                       placeholder="Enter video title" />
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h3 class="mb-0">@GetDisplayTitle(video)</h3>
                                    <small class="text-muted">
                                        @FormatFileSize(video.SizeInBytes) â€¢ 
                                        @(video.LastModified?.LocalDateTime.ToString("g") ?? "Unknown")
                                    </small>
                                </div>
                                @if (isOwner)
                                {
                                    <button class="btn btn-outline-primary btn-sm" @onclick="StartEdit">
                                        <span class="bi bi-pencil"></span> Edit
                                    </button>
                                }
                            </div>
                        }
                    </div>
                    <div class="card-body p-0">
                        @if (!string.IsNullOrEmpty(videoPlayerError))
                        {
                            <div class="alert alert-danger m-3" role="alert">
                                <strong>Error!</strong> @videoPlayerError
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(currentVideoUrl))
                        {
                            <div class="ratio ratio-16x9">
                                <video @ref="videoElement" 
                                       controls 
                                       autoplay 
                                       preload="metadata" 
                                       class="w-100"
                                       @onerror="OnVideoError"
                                       @onloadedmetadata="OnVideoMetadataLoaded"
                                       @oncanplay="OnVideoCanPlay">
                                    <source src="@currentVideoUrl" type="@video.ContentType">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div class="p-3">
                                <small class="text-muted">If the video doesn't play, try clicking the play button.</small>
                            </div>
                        }
                        
                        @if (isEditing)
                        {
                            <div class="p-3 border-top">
                                <div class="mb-3">
                                    <label for="editDescription" class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" 
                                              id="editDescription" 
                                              @bind="editDescription"
                                              rows="4"
                                              placeholder="Enter video description"
                                              maxlength="2000"></textarea>
                                    <div class="form-text">
                                        @(editDescription?.Length ?? 0)/2000 characters
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editVideoDate" class="form-label fw-bold">Video Date</label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="editVideoDate" 
                                           @bind="editVideoDate" />
                                    <div class="form-text">
                                        The date when this video was originally recorded.
                                    </div>
                                </div>
                                
                                @if (!string.IsNullOrEmpty(editErrorMessage))
                                {
                                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                        <strong>Error!</strong> @editErrorMessage
                                        <button type="button" class="btn-close" @onclick="ClearEditMessages"></button>
                                    </div>
                                }
                                else if (!string.IsNullOrEmpty(editSuccessMessage))
                                {
                                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                                        <strong>Success!</strong> @editSuccessMessage
                                        <button type="button" class="btn-close" @onclick="ClearEditMessages"></button>
                                    </div>
                                }
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" @onclick="SaveEdit" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                            <span>Saving...</span>
                                        }
                                        else
                                        {
                                            <span class="bi bi-check-lg"></span>
                                            <span> Save Changes</span>
                                        }
                                    </button>
                                    <button class="btn btn-secondary" @onclick="CancelEdit" disabled="@isSaving">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        }
                        else if (!string.IsNullOrWhiteSpace(video.Description) || video.VideoDate.HasValue)
                        {
                            <div class="p-3 border-top">
                                @if (!string.IsNullOrWhiteSpace(video.Description))
                                {
                                    <div class="mb-3">
                                        <h6 class="fw-bold">Description</h6>
                                        <p class="mb-0" style="white-space: pre-wrap;">@video.Description</p>
                                    </div>
                                }
                                @if (video.VideoDate.HasValue)
                                {
                                    <div>
                                        <h6 class="fw-bold">Video Date</h6>
                                        <p class="mb-0">@video.VideoDate.Value.ToString("MMMM dd, yyyy")</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>File:</strong> @video.FileName
                                </small>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <small class="text-muted">
                                    <strong>Type:</strong> @video.ContentType
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string BlobName { get; set; } = string.Empty;
    
    private VideoInfo? video;
    private string? currentVideoUrl;
    private bool isLoadingVideo = true;
    private string? errorMessage;
    private string? videoPlayerError;
    private ElementReference videoElement;
    
    // Ownership and editing state
    private bool isOwner = false;
    private string? currentUserId;
    private bool isEditing = false;
    private bool isSaving = false;
    private string? editTitle;
    private string? editDescription;
    private DateOnly? editVideoDate;
    private string? editErrorMessage;
    private string? editSuccessMessage;

    protected override async Task OnInitializedAsync()
    {
        await GetCurrentUserIdAsync();
        await LoadVideoAsync();
    }
    
    private async Task GetCurrentUserIdAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                currentUserId = user.FindFirst(c => c.Type == "sub")?.Value
                    ?? user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                
                Logger.LogInformation("Current user ID: {UserId}", currentUserId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error getting current user ID");
        }
    }

    private async Task LoadVideoAsync()
    {
        if (string.IsNullOrEmpty(BlobName))
        {
            errorMessage = "No video specified.";
            isLoadingVideo = false;
            return;
        }

        isLoadingVideo = true;
        errorMessage = null;
        videoPlayerError = null;

        try
        {
            // First, get the list of videos to find details about this video
            var videos = await ApiClient.GetVideosAsync();
            video = videos.FirstOrDefault(v => v.BlobName == BlobName);
            
            if (video == null)
            {
                errorMessage = "Video not found.";
                return;
            }
            
            // Check if current user is the owner
            isOwner = !string.IsNullOrEmpty(currentUserId) && video.OwnerId == currentUserId;
            Logger.LogInformation("Video owner check - Current: {CurrentUserId}, Owner: {OwnerId}, IsOwner: {IsOwner}", 
                currentUserId, video.OwnerId, isOwner);

            // Get the video URL
            currentVideoUrl = await ApiClient.GetVideoUrlAsync(BlobName);
            Logger.LogInformation("Loaded video URL for: {FileName}, URL: {Url}", video.FileName, currentVideoUrl);
            Console.WriteLine($"Video URL: {currentVideoUrl}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load video: {ex.Message}";
            Logger.LogError(ex, "Error loading video: {BlobName}", BlobName);
            Console.WriteLine($"Error getting video: {ex.Message}");
        }
        finally
        {
            isLoadingVideo = false;
        }
    }
    
    private void StartEdit()
    {
        if (video == null) return;
        
        isEditing = true;
        editTitle = video.Title ?? video.FileName;
        editDescription = video.Description;
        editVideoDate = video.VideoDate.HasValue ? DateOnly.FromDateTime(video.VideoDate.Value) : null;
        ClearEditMessages();
    }
    
    private async Task SaveEdit()
    {
        if (video == null || string.IsNullOrWhiteSpace(editTitle))
        {
            editErrorMessage = "Title is required.";
            return;
        }
        
        isSaving = true;
        ClearEditMessages();
        
        try
        {
            var response = await ApiClient.UpdateVideoMetadataAsync(
                BlobName,
                editTitle,
                editDescription,
                editVideoDate
            );
            
            if (response.Success)
            {
                // Update the local video object
                video = video with 
                { 
                    Title = response.Title,
                    Description = response.Description,
                    VideoDate = response.VideoDate
                };
                
                editSuccessMessage = "Video updated successfully!";
                Logger.LogInformation("Video metadata updated: {BlobName}", BlobName);
                
                // Exit edit mode after a brief delay
                await Task.Delay(1500);
                isEditing = false;
                ClearEditMessages();
            }
            else
            {
                editErrorMessage = response.Message ?? "Failed to update video.";
            }
        }
        catch (Exception ex)
        {
            editErrorMessage = $"Error updating video: {ex.Message}";
            Logger.LogError(ex, "Error updating video metadata for: {BlobName}", BlobName);
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private void CancelEdit()
    {
        isEditing = false;
        editTitle = null;
        editDescription = null;
        editVideoDate = null;
        ClearEditMessages();
    }
    
    private void ClearEditMessages()
    {
        editErrorMessage = null;
        editSuccessMessage = null;
    }

    private void GoBackToList()
    {
        NavigationManager.NavigateTo("/videos");
    }

    private void OnVideoError()
    {
        Console.WriteLine("Video error occurred!");
        videoPlayerError = "Video failed to load. The video format may not be supported by your browser, or the file may be corrupted.";
    }

    private void OnVideoMetadataLoaded()
    {
        Console.WriteLine("Video metadata loaded successfully");
    }

    private void OnVideoCanPlay()
    {
        Console.WriteLine("Video can play - ready to start playback");
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetDisplayTitle(VideoInfo video)
    {
        return !string.IsNullOrWhiteSpace(video.Title) ? video.Title : video.FileName;
    }
}


@page "/"
@inject BlinkApiClient ApiClient
@attribute [StreamRendering]

<PageTitle>Home</PageTitle>

<div style="margin-bottom: 2rem;">
    <h2>Public API Test</h2>
    @if (PublicMessage is null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <p>✓ @PublicMessage</p>
    }
</div>

<AuthorizeView>
    <Authorized>
        <div style="margin-bottom: 2rem;">
            <h2>Authenticated API Test</h2>
            @if (AuthenticatedMessage is null)
            {
                <p><em>Loading...</em></p>
            }
            else if (AuthError is not null)
            {
                <p style="color: red;">❌ Error: @AuthError</p>
            }
            else
            {
                <p>✓ @AuthenticatedMessage</p>
            }
        </div>

        <div style="margin-bottom: 2rem;">
            <h2>Your Claims from API</h2>
            @if (ApiClaims is null)
            {
                <p><em>Loading...</em></p>
            }
            else if (ClaimsError is not null)
            {
                <p style="color: red;">❌ Error: @ClaimsError</p>
            }
            else
            {
                <ul>
                    @foreach (var claim in ApiClaims)
                    {
                        <li>@claim.Key = @string.Join(", ", claim.Value)</li>
                    }
                </ul>
            }
        </div>

        <div>
            <h2>Your Claims (Server-Side)</h2>
            <ul>
                @foreach (var claim in context.User.Claims)
                {
                    <li>@claim.Type = @claim.Value</li>
                }
            </ul>
        </div>
    </Authorized>
    <NotAuthorized>
        <p>Please log in to test authenticated API calls.</p>
    </NotAuthorized>
</AuthorizeView>

@code {

    public IReadOnlyDictionary<string, string[]>? ApiClaims { get; private set; }
    public string? AuthError { get; private set; }
    public string? AuthenticatedMessage { get; private set; }
    public string? ClaimsError { get; private set; }
    public string? PublicMessage { get; private set; }

    protected override async Task OnInitializedAsync()
    {
        // Test public endpoint
        try
        {
            PublicMessage = await ApiClient.GetTestMessage();
        }
        catch (Exception ex)
        {
            PublicMessage = $"Error: {ex.Message}";
        }

        // Test authenticated endpoints (only after auth state is available)
        try
        {
            AuthenticatedMessage = await ApiClient.GetAuthenticatedTestMessage();
        }
        catch (Exception ex)
        {
            AuthError = ex.Message;
        }

        // Test getting claims from the API
        try
        {
            ApiClaims = await ApiClient.GetClaims();
        }
        catch (Exception ex)
        {
            ClaimsError = ex.Message;
        }
    }
}

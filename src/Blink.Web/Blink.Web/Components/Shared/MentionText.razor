@if (!string.IsNullOrEmpty(Text))
{
    @((MarkupString)RenderTextWithMentions(Text, Mentions))
}

@code {
    [Parameter]
    public string? Text { get; set; }

    [Parameter]
    public List<MentionMetadata>? Mentions { get; set; }

    [Parameter]
    public string CssClass { get; set; } = "text-gray-700 dark:text-gray-300 whitespace-pre-wrap";

    public class MentionMetadata
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int Position { get; set; }
        public int Length { get; set; }
    }

    private string RenderTextWithMentions(string text, List<MentionMetadata>? mentions)
    {
        if (string.IsNullOrEmpty(text))
        {
            return string.Empty;
        }

        // If no mentions, just return plain text
        if (mentions == null || mentions.Count == 0)
        {
            return $"<div class=\"{CssClass}\">{System.Net.WebUtility.HtmlEncode(text)}</div>";
        }

        // Render with mention metadata
        var result = new System.Text.StringBuilder();
        var sortedMentions = mentions.OrderBy(m => m.Position).ToList();
        var lastIndex = 0;

        foreach (var mention in sortedMentions)
        {
            // Add text before the mention
            if (mention.Position > lastIndex)
            {
                var beforeText = text.Substring(lastIndex, mention.Position - lastIndex);
                result.Append(System.Net.WebUtility.HtmlEncode(beforeText));
            }

            // Add the styled mention
            var mentionText = text.Substring(mention.Position, Math.Min(mention.Length, text.Length - mention.Position));
            result.Append($"<span class=\"mention-tag\" data-mention-id=\"{System.Net.WebUtility.HtmlEncode(mention.Id)}\">{System.Net.WebUtility.HtmlEncode(mentionText)}</span>");

            lastIndex = mention.Position + mention.Length;
        }

        // Add remaining text after last mention
        if (lastIndex < text.Length)
        {
            var remainingText = text.Substring(lastIndex);
            result.Append(System.Net.WebUtility.HtmlEncode(remainingText));
        }

        return $"<div class=\"{CssClass}\">{result}</div>";
    }
}

